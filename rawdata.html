<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RawData íŒŒì¼ ì²˜ë¦¬ - í™”ì¸í†µìƒ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        .rawdata-container {
            width: 100%;
            height: 100vh;
            background-color: white;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rawdata-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rawdata-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        
        .rawdata-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .rawdata-table th,
        .rawdata-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }
        
        .rawdata-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #1a252f;
        }
        
        .rawdata-table th.sortable-header {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .rawdata-table th.sortable-header:hover {
            background: linear-gradient(135deg, #34495e 0%, #4a6278 100%);
        }
        
        .rawdata-table th.checkbox-header,
        .rawdata-table th.row-number-header {
            background: #1a252f;
            text-align: center;
        }
        
        .rawdata-table th.checkbox-header {
            width: 40px;
            min-width: 40px;
        }
        
        .rawdata-table th.row-number-header {
            width: 50px;
            min-width: 50px;
        }
        
        .rawdata-table td.checkbox-cell,
        .rawdata-table td.row-number {
            text-align: center;
            background: #f8f9fa;
        }
        
        .rawdata-table td.checkbox-cell {
            border-right: 1px solid #dee2e6;
        }
        
        .rawdata-table td.row-number {
            font-weight: 600;
            color: #6c757d;
            border-right: 2px solid #dee2e6;
        }
        
        .rawdata-table tbody tr {
            background: white;
        }
        
        .rawdata-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .rawdata-table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        .rawdata-table tbody tr.selected-row {
            background-color: #d4edda !important;
        }
        
        .rawdata-table tbody tr.selected-row:hover {
            background-color: #c3e6cb !important;
        }
        
        .rawdata-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .empty-message {
            text-align: center;
            padding: 80px 20px;
            color: #888;
            font-size: 16px;
        }
        
        .empty-message .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .rawdata-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            gap: 10px;
        }
        
        .rawdata-toolbar .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rawdata-toolbar .btn-convert {
            background: #17a2b8;
            color: white;
        }
        
        .rawdata-toolbar .btn-convert:hover {
            background: #138496;
        }
        
        .rawdata-toolbar .btn-register {
            background: #28a745;
            color: white;
        }
        
        .rawdata-toolbar .btn-register:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="rawdata-container">
        <div class="rawdata-toolbar">
            <button class="btn btn-convert" onclick="convertData()">ë³€í™˜</button>
            <button class="btn btn-register" onclick="registerData()">ë“±ë¡</button>
        </div>
        <div class="rawdata-content">
            <div class="rawdata-table-wrapper">
                <table id="rawDataTable" class="rawdata-table">
                    <thead id="rawDataTableHead">
                        <!-- ì„ íƒëœ íŒŒì¼ì˜ 1í–‰ì´ í—¤ë”ë¡œ ë™ì  ìƒì„±ë¨ -->
                    </thead>
                    <tbody id="rawDataTableBody">
                        <!-- 2í–‰ë¶€í„° ë°ì´í„°ë¡œ í‘œì‹œë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ ë°ì´í„° ì½ì–´ì„œ í…Œì´ë¸” ìƒì„±
        document.addEventListener('DOMContentLoaded', function() {
            const storedData = localStorage.getItem('rawDataContent');
            if (storedData) {
                try {
                    const jsonData = JSON.parse(storedData);
                    createDataTable(jsonData);
                    // ì‚¬ìš© í›„ localStorage ì •ë¦¬
                    localStorage.removeItem('rawDataContent');
                    localStorage.removeItem('rawDataFileName');
                } catch (error) {
                    console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            }
        });
        
        // í…Œì´ë¸” ìƒì„±
        function createDataTable(data) {
            const tableHead = document.getElementById('rawDataTableHead');
            const tableBody = document.getElementById('rawDataTableBody');
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                return;
            }
            
            // === 1í–‰(ì²« ë²ˆì§¸ í–‰)ì„ í—¤ë”ë¡œ ì‚¬ìš© ===
            const headers = data[0];
            const headerRow = document.createElement('tr');
            
            // ì²´í¬ë°•ìŠ¤ í—¤ë” ì¶”ê°€ (ì „ì²´ ì„ íƒ)
            const thCheck = document.createElement('th');
            thCheck.className = 'checkbox-header';
            const checkAll = document.createElement('input');
            checkAll.type = 'checkbox';
            checkAll.id = 'checkAllRows';
            checkAll.title = 'ì „ì²´ ì„ íƒ/í•´ì œ';
            checkAll.onchange = function() { toggleAllRowCheckboxes(this.checked); };
            thCheck.appendChild(checkAll);
            headerRow.appendChild(thCheck);
            
            // ìˆœë²ˆ í—¤ë” ì¶”ê°€
            const thNo = document.createElement('th');
            thNo.textContent = 'No.';
            thNo.className = 'row-number-header';
            headerRow.appendChild(thNo);
            
            // Excel 1í–‰ì˜ ê° ì…€ì„ í—¤ë”ë¡œ ì‚¬ìš©
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header || `Column ${index + 1}`;
                th.className = 'sortable-header';
                th.dataset.colIndex = index + 2;
                th.onclick = function() { sortTable(index + 2); };
                th.title = `í´ë¦­í•˜ì—¬ ì •ë ¬ (í—¤ë”: ${header || 'Column ' + (index + 1)})`;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            console.log(`ğŸ“ í—¤ë” ìƒì„± ì™„ë£Œ: ${headers.length}ê°œ ì»¬ëŸ¼ (Excel 1í–‰ ê¸°ì¤€)`);
            
            // === 2í–‰ë¶€í„° ë°ì´í„° í–‰ìœ¼ë¡œ í‘œì‹œ ===
            let dataRowCount = 0;
            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°
                if (!rowData || rowData.every(cell => cell === null || cell === undefined || cell === '')) continue;
                
                dataRowCount++;
                const row = document.createElement('tr');
                row.dataset.rowIndex = dataRowCount;
                
                // ì²´í¬ë°•ìŠ¤ ì…€ ì¶”ê°€
                const tdCheck = document.createElement('td');
                tdCheck.className = 'checkbox-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-checkbox';
                checkbox.dataset.rowIndex = dataRowCount;
                checkbox.onchange = function() { updateRowSelection(this); };
                tdCheck.appendChild(checkbox);
                row.appendChild(tdCheck);
                
                // ìˆœë²ˆ ì…€ ì¶”ê°€
                const tdNo = document.createElement('td');
                tdNo.textContent = dataRowCount;
                tdNo.className = 'row-number';
                row.appendChild(tdNo);
                
                // ë°ì´í„° ì…€
                for (let j = 0; j < headers.length; j++) {
                    const td = document.createElement('td');
                    td.textContent = rowData[j] !== undefined && rowData[j] !== null ? rowData[j] : '';
                    row.appendChild(td);
                }
                
                tableBody.appendChild(row);
            }
            
            // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
            window.rawDataContent = data;
            
            console.log(`âœ… í…Œì´ë¸” ìƒì„± ì™„ë£Œ: í—¤ë” ${headers.length}ê°œ, ë°ì´í„° ${dataRowCount}í–‰`);
        }
        
        // ì „ì²´ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleAllRowCheckboxes(checked) {
            const checkboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                updateRowSelection(cb);
            });
            console.log(`â˜‘ï¸ ì „ì²´ ${checked ? 'ì„ íƒ' : 'í•´ì œ'}: ${checkboxes.length}í–‰`);
        }
        
        // í–‰ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateRowSelection(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.add('selected-row');
            } else {
                row.classList.remove('selected-row');
            }
            
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            const allCheckboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox');
            const checkedCount = document.querySelectorAll('#rawDataTableBody .row-checkbox:checked').length;
            const checkAll = document.getElementById('checkAllRows');
            if (checkAll) {
                checkAll.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
                checkAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
            }
        }
        
        // ì„ íƒëœ í–‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getSelectedRows() {
            const selectedRows = [];
            const checkboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox:checked');
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const rowData = [];
                row.querySelectorAll('td').forEach((td, idx) => {
                    if (idx > 1) { // ì²´í¬ë°•ìŠ¤, ìˆœë²ˆ ì œì™¸
                        rowData.push(td.textContent);
                    }
                });
                selectedRows.push(rowData);
            });
            return selectedRows;
        }
        
        // í…Œì´ë¸” ì •ë ¬
        function sortTable(colIndex) {
            const table = document.getElementById('rawDataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (rows.length === 0) return;
            
            // ì •ë ¬ ë°©í–¥ í† ê¸€
            const currentDir = table.dataset.sortDir === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDir = currentDir;
            
            rows.sort((a, b) => {
                const aVal = a.cells[colIndex]?.textContent.trim() || '';
                const bVal = b.cells[colIndex]?.textContent.trim() || '';
                
                // ìˆ«ì ë¹„êµ
                const aNum = parseFloat(aVal.replace(/,/g, ''));
                const bNum = parseFloat(bVal.replace(/,/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // ë¬¸ìì—´ ë¹„êµ
                return currentDir === 'asc' 
                    ? aVal.localeCompare(bVal, 'ko') 
                    : bVal.localeCompare(aVal, 'ko');
            });
            
            // ìˆœë²ˆ ì¬ì„¤ì • ë° í–‰ ì¬ì‚½ì…
            rows.forEach((row, idx) => {
                row.cells[1].textContent = idx + 1; // ìˆœë²ˆ ì…€ (ì¸ë±ìŠ¤ 1)
                tbody.appendChild(row);
            });
            
            console.log(`ğŸ“Š ì •ë ¬ ì™„ë£Œ: ì»¬ëŸ¼ ${colIndex}, ${currentDir}`);
        }
        
        // ë³€í™˜ ë²„íŠ¼ í´ë¦­
        function convertData() {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                alert('ë³€í™˜í•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í˜„ì¬ í…Œì´ë¸” í—¤ë” ê°€ì ¸ì˜¤ê¸°
            const headers = [];
            document.querySelectorAll('#rawDataTableHead th.sortable-header').forEach(th => {
                headers.push(th.textContent.trim());
            });
            
            // í—¤ë” ë§¤í•‘ (rawdata í—¤ë” â†’ containerTable í—¤ë”)
            // ì°¨ìˆœ â†’ SEAL, container â†’ í˜•íƒœ, B/L No â†’ Bl, ì…ê³ ìš”ì²­ì¼ â†’ ë°˜ì…ì¼, ë°œì£¼ í’ˆëª© â†’ í’ˆëª…
            const headerMapping = {
                'ì°¨ìˆœ': 'SEAL',
                'container': 'í˜•íƒœ',
                'Container': 'í˜•íƒœ',
                'CONTAINER': 'í˜•íƒœ',
                'B/L No': 'Bl',
                'B/L NO': 'Bl',
                'B/L no': 'Bl',
                'ì…ê³ ìš”ì²­ì¼': 'ë°˜ì…ì¼',
                'ë°œì£¼ í’ˆëª©': 'í’ˆëª…',
                'ë°œì£¼í’ˆëª©': 'í’ˆëª…'
            };
            
            // containerTable í—¤ë” ìˆœì„œ
            const containerTableHeaders = ['ë°˜ì…ì¼', 'í™”ì£¼ëª…', 'ì»¨í…Œì´ë„ˆë²ˆí˜¸', 'SEAL', 'Bl', 'í’ˆëª…', 'ìˆ˜ëŸ‰(EA)', 'ìˆ˜ëŸ‰(PLT)', 'ê·œê²©', 'í˜•íƒœ', 'íŠ¹ì´ì‚¬í•­'];
            
            // ê° rawdata í—¤ë”ê°€ containerTableì˜ ì–´ëŠ ì»¬ëŸ¼ì— ë§¤í•‘ë˜ëŠ”ì§€ ì°¾ê¸°
            const columnMapping = {};
            headers.forEach((header, idx) => {
                const mappedHeader = headerMapping[header] || headerMapping[header.trim()] || null;
                if (mappedHeader) {
                    const targetIdx = containerTableHeaders.indexOf(mappedHeader);
                    if (targetIdx !== -1) {
                        columnMapping[idx] = targetIdx;
                    }
                }
            });
            
            console.log('í—¤ë” ëª©ë¡:', headers);
            console.log('ì»¬ëŸ¼ ë§¤í•‘:', columnMapping);
            
            // ì„ íƒëœ í–‰ ë°ì´í„°ë¥¼ containerTable í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const convertedData = selectedRows.map(rowData => {
                const newRow = new Array(containerTableHeaders.length).fill('');
                rowData.forEach((cellData, idx) => {
                    if (columnMapping[idx] !== undefined) {
                        newRow[columnMapping[idx]] = cellData;
                    }
                });
                return newRow;
            });
            
            console.log('ë³€í™˜ëœ ë°ì´í„°:', convertedData);
            
            // localStorageì— ë³€í™˜ëœ ë°ì´í„° ì €ì¥
            localStorage.setItem('convertedRawData', JSON.stringify({
                headers: containerTableHeaders,
                data: convertedData
            }));
            
            alert(`${selectedRows.length}ê°œ í–‰ì´ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
            
            // ì›ë˜ ì°½(opener)ì— ë°ì´í„° ì „ë‹¬ ì‹œë„
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.loadConvertedRawData();
                } catch (e) {
                    console.log('opener í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨:', e);
                }
            }
        }
        
        // ë“±ë¡ ë²„íŠ¼ í´ë¦­
        function registerData() {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                alert('ë“±ë¡í•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            console.log('ë“±ë¡í•  ë°ì´í„°:', selectedRows);
            alert(`${selectedRows.length}ê°œ í–‰ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.`);
        }
    </script>
</body>
</html>
