<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RawData íŒŒì¼ ì²˜ë¦¬ - í™”ì¸í†µìƒ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        .rawdata-container {
            width: 100%;
            height: 100vh;
            background-color: white;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rawdata-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rawdata-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        
        .rawdata-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .rawdata-table th,
        .rawdata-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }
        
        .rawdata-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #1a252f;
        }
        
        .rawdata-table th.sortable-header {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .rawdata-table th.sortable-header:hover {
            background: linear-gradient(135deg, #34495e 0%, #4a6278 100%);
        }
        
        .rawdata-table th.checkbox-header,
        .rawdata-table th.row-number-header {
            background: #1a252f;
            text-align: center;
        }
        
        .rawdata-table th.checkbox-header {
            width: 40px;
            min-width: 40px;
        }
        
        .rawdata-table th.row-number-header {
            width: 50px;
            min-width: 50px;
        }
        
        .rawdata-table td.checkbox-cell,
        .rawdata-table td.row-number {
            text-align: center;
            background: #f8f9fa;
        }
        
        .rawdata-table td.checkbox-cell {
            border-right: 1px solid #dee2e6;
        }
        
        .rawdata-table td.row-number {
            font-weight: 600;
            color: #6c757d;
            border-right: 2px solid #dee2e6;
        }
        
        .rawdata-table tbody tr {
            background: white;
        }
        
        .rawdata-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .rawdata-table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        .rawdata-table tbody tr.selected-row {
            background-color: #d4edda !important;
        }
        
        .rawdata-table tbody tr.selected-row:hover {
            background-color: #c3e6cb !important;
        }
        
        .rawdata-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* í¸ì§‘ ê°€ëŠ¥í•œ ì…€ ìŠ¤íƒ€ì¼ (ë°œì£¼ í’ˆëª© ì „ìš©) */
        .rawdata-table td.editable {
            background: #fffdfa;
            border-left: 2px solid #ffd966;
        }
        .rawdata-table td.editable:focus {
            outline: 2px solid #ffc107;
            background: #fff7e6;
        }
        .rawdata-table td.editable::selection {
            background: #ffe8a1;
        }
        
        .empty-message {
            text-align: center;
            padding: 80px 20px;
            color: #888;
            font-size: 16px;
        }
        
        .empty-message .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .rawdata-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            gap: 10px;
        }
        
        .rawdata-toolbar .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rawdata-toolbar .btn-convert {
            background: #17a2b8;
            color: white;
        }
        
        .rawdata-toolbar .btn-convert:hover {
            background: #138496;
        }
        
        .rawdata-toolbar .btn-register {
            background: #28a745;
            color: white;
        }
        
        .rawdata-toolbar .btn-register:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="rawdata-container">
        <div class="rawdata-toolbar">
            <div style="display: flex; align-items: center; gap: 15px; margin-right: auto;">
                <label for="shipperSelect" style="color: white; font-weight: bold; font-size: 14px; white-space: nowrap;">í™”ì£¼ëª…:</label>
                <select id="shipperSelect" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; min-width: 200px;">
                    <option value="">-- ì„ íƒí•´ì£¼ì„¸ìš” --</option>
                    <option value="__custom__">ì§ì ‘ì…ë ¥</option>
                </select>
                <input type="text" id="shipperInput" placeholder="í™”ì£¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="display: none; padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; min-width: 200px;">
            </div>
            <button class="btn btn-convert" onclick="convertData()">ë³€í™˜</button>
            <button class="btn btn-register" onclick="registerData()">ë“±ë¡</button>
        </div>
        <div class="rawdata-content">
            <div class="rawdata-table-wrapper">
                <table id="rawDataTable" class="rawdata-table">
                    <thead id="rawDataTableHead">
                        <!-- ì„ íƒëœ íŒŒì¼ì˜ 1í–‰ì´ í—¤ë”ë¡œ ë™ì  ìƒì„±ë¨ -->
                    </thead>
                    <tbody id="rawDataTableBody">
                        <!-- 2í–‰ë¶€í„° ë°ì´í„°ë¡œ í‘œì‹œë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // í™”ì£¼ëª… select ë³€ê²½ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const shipperSelect = document.getElementById('shipperSelect');
            const shipperInput = document.getElementById('shipperInput');
            
            shipperSelect.addEventListener('change', function() {
                if (this.value === '__custom__') {
                    shipperSelect.style.display = 'none';
                    shipperInput.style.display = 'block';
                    shipperInput.focus();
                    shipperInput.value = '';
                } else {
                    shipperInput.style.display = 'none';
                    shipperSelect.style.display = 'block';
                }
            });
            
            const storedData = localStorage.getItem('rawDataContent');
            if (storedData) {
                try {
                    const jsonData = JSON.parse(storedData);
                    createDataTable(jsonData);
                    // ì‚¬ìš© í›„ localStorage ì •ë¦¬
                    localStorage.removeItem('rawDataContent');
                    localStorage.removeItem('rawDataFileName');
                } catch (error) {
                    console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            }
        });
        
        // í…Œì´ë¸” ìƒì„±
        function createDataTable(data) {
            const tableHead = document.getElementById('rawDataTableHead');
            const tableBody = document.getElementById('rawDataTableBody');
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                return;
            }
            
            // === 1í–‰(ì²« ë²ˆì§¸ í–‰)ì„ í—¤ë”ë¡œ ì‚¬ìš© ===
            const headers = data[0];
            const headerRow = document.createElement('tr');
            
            // ì²´í¬ë°•ìŠ¤ í—¤ë” ì¶”ê°€ (ì „ì²´ ì„ íƒ)
            const thCheck = document.createElement('th');
            thCheck.className = 'checkbox-header';
            const checkAll = document.createElement('input');
            checkAll.type = 'checkbox';
            checkAll.id = 'checkAllRows';
            checkAll.title = 'ì „ì²´ ì„ íƒ/í•´ì œ';
            checkAll.onchange = function() { toggleAllRowCheckboxes(this.checked); };
            thCheck.appendChild(checkAll);
            headerRow.appendChild(thCheck);
            
            // ìˆœë²ˆ í—¤ë” ì¶”ê°€
            const thNo = document.createElement('th');
            thNo.textContent = 'No.';
            thNo.className = 'row-number-header';
            headerRow.appendChild(thNo);
            
            // Excel 1í–‰ì˜ ê° ì…€ì„ í—¤ë”ë¡œ ì‚¬ìš©
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header || `Column ${index + 1}`;
                th.className = 'sortable-header';
                th.dataset.colIndex = index + 2;
                th.onclick = function() { sortTable(index + 2); };
                th.title = `í´ë¦­í•˜ì—¬ ì •ë ¬ (í—¤ë”: ${header || 'Column ' + (index + 1)})`;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // === 2í–‰ë¶€í„° ë°ì´í„° í–‰ìœ¼ë¡œ í‘œì‹œ ===
            let dataRowCount = 0;
            // "ë°œì£¼ í’ˆëª©" ì»¬ëŸ¼ ì¸ë±ìŠ¤ íƒìƒ‰ (ë³€í˜• í‘œê¸° í—ˆìš©)
            const itemHeaderIndex = headers.findIndex(h => {
                const t = (h || '').toString().trim();
                return t === 'ë°œì£¼ í’ˆëª©' || t === 'ë°œì£¼í’ˆëª©';
            });
            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°
                if (!rowData || rowData.every(cell => cell === null || cell === undefined || cell === '')) continue;
                
                dataRowCount++;
                const row = document.createElement('tr');
                row.dataset.rowIndex = dataRowCount;
                
                // ì²´í¬ë°•ìŠ¤ ì…€ ì¶”ê°€
                const tdCheck = document.createElement('td');
                tdCheck.className = 'checkbox-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-checkbox';
                checkbox.dataset.rowIndex = dataRowCount;
                checkbox.onchange = function() { updateRowSelection(this); };
                tdCheck.appendChild(checkbox);
                row.appendChild(tdCheck);
                
                // ìˆœë²ˆ ì…€ ì¶”ê°€
                const tdNo = document.createElement('td');
                tdNo.textContent = dataRowCount;
                tdNo.className = 'row-number';
                row.appendChild(tdNo);
                
                // ë°ì´í„° ì…€
                for (let j = 0; j < headers.length; j++) {
                    const td = document.createElement('td');
                    td.textContent = rowData[j] !== undefined && rowData[j] !== null ? rowData[j] : '';
                    // ë°œì£¼ í’ˆëª© ì»¬ëŸ¼ì€ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ì²˜ë¦¬
                    if (j === itemHeaderIndex) {
                        td.contentEditable = 'true';
                        td.classList.add('editable');
                        td.title = 'í´ë¦­í•˜ì—¬ ë°œì£¼ í’ˆëª©ì„ í¸ì§‘í•˜ì„¸ìš” (Enterë¡œ ì™„ë£Œ)';
                        td.setAttribute('tabindex', '0');
                        // Enterë¡œ í¸ì§‘ ì¢…ë£Œ
                        td.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                this.blur();
                            }
                        });
                        // ë¶™ì—¬ë„£ê¸° ì‹œ í…ìŠ¤íŠ¸ë§Œ ìœ ì§€
                        td.addEventListener('paste', function(e) {
                            e.preventDefault();
                            const text = (e.clipboardData || window.clipboardData).getData('text');
                            document.execCommand('insertText', false, text);
                        });
                        // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ê³µë°± ì •ë¦¬
                        td.addEventListener('blur', function() {
                            const cleaned = this.textContent.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
                            this.textContent = cleaned;
                        });
                    }
                    row.appendChild(td);
                }
                
                tableBody.appendChild(row);
            }
            
            // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
            window.rawDataContent = data;
            
            // í™”ì£¼ëª… ì»¬ëŸ¼ ì°¾ê¸° ë° unique ê°’ìœ¼ë¡œ select options ìƒì„±
            extractAndPopulateShippers(headers, data);
        }
        
        // í™”ì£¼ëª… ì»¬ëŸ¼ì„ ì°¾ì•„ì„œ unique ê°’ìœ¼ë¡œ select options ìƒì„±
        function extractAndPopulateShippers(headers, data) {
            // í™”ì£¼ëª… ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸° (ë‹¤ì–‘í•œ í‘œê¸° í—ˆìš©)
            const shipperHeaderIndex = headers.findIndex(h => {
                const t = (h || '').toString().trim();
                return t === 'í™”ì£¼' || t === 'í™”ì£¼ëª…' || t === 'ì—…ì²´ëª…' || t === 'ê³µê¸‰ì‚¬' || t === 'ê³µê¸‰ì' || t === 'ê±°ë˜ì²˜';
            });
            
            if (shipperHeaderIndex === -1) {
                console.log('âš ï¸ í™”ì£¼ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
       
        // 2í–‰ë¶€í„° ì‹œì‘í•´ì„œ í™”ì£¼ëª… ê°’ ìˆ˜ì§‘
            const shippers = new Set();
            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                if (rowData && rowData[shipperHeaderIndex]) {
                    const shipper = rowData[shipperHeaderIndex].toString().trim();
                    if (shipper.length > 0) {
                        shippers.add(shipper);
                    }
                }
            }
            
            console.log(`âœ… ${shippers.size}ê°œì˜ unique í™”ì£¼ëª… ë°œê²¬:`, Array.from(shippers));
            
            // select options ì—…ë°ì´íŠ¸
            const shipperSelect = document.getElementById('shipperSelect');
            const existingOptions = shipperSelect.querySelectorAll('option');
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° ("ì„ íƒí•´ì£¼ì„¸ìš”"ì™€ "ì§ì ‘ì…ë ¥" ì œì™¸)
            for (let i = existingOptions.length - 1; i >= 2; i--) {
                shipperSelect.removeChild(existingOptions[i]);
            }
            
            // í™”ì£¼ëª… ì˜µì…˜ ì¶”ê°€ (ì•ŒíŒŒë²³ìˆœ ì •ë ¬)
            Array.from(shippers).sort().forEach(shipper => {
                const option = document.createElement('option');
                option.value = shipper;
                option.textContent = shipper;
                shipperSelect.insertBefore(option, shipperSelect.querySelector('option[value="__custom__"]'));
            });
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (convertDataì—ì„œ ì‚¬ìš©)
            window.shipperHeaderIndex = shipperHeaderIndex;
        }
        
        // ì „ì²´ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleAllRowCheckboxes(checked) {
            const checkboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                updateRowSelection(cb);
            });
        }
        
        // í–‰ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateRowSelection(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.add('selected-row');
            } else {
                row.classList.remove('selected-row');
            }
            
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            const allCheckboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox');
            const checkedCount = document.querySelectorAll('#rawDataTableBody .row-checkbox:checked').length;
            const checkAll = document.getElementById('checkAllRows');
            if (checkAll) {
                checkAll.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
                checkAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
            }
        }
        
        // ì„ íƒëœ í–‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getSelectedRows() {
            const selectedRows = [];
            const checkboxes = document.querySelectorAll('#rawDataTableBody .row-checkbox:checked');
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const rowData = [];
                row.querySelectorAll('td').forEach((td, idx) => {
                    if (idx > 1) { // ì²´í¬ë°•ìŠ¤, ìˆœë²ˆ ì œì™¸
                        rowData.push(td.textContent);
                    }
                });
                selectedRows.push(rowData);
            });
            return selectedRows;
        }

        // ì‰¼í‘œê°€ ìˆ«ì ì‚¬ì´ì¼ ë•Œ(ì²œë‹¨ìœ„ êµ¬ë¶„) ë¶„ë¦¬í•˜ì§€ ì•ŠëŠ” split í•¨ìˆ˜
        function splitItemsPreservingThousands(str) {
            if (!str || typeof str !== 'string') return [];
            const items = [];
            let current = '';
            for (let i = 0; i < str.length; i++) {
                const ch = str[i];
                if (ch === ',') {
                    const prev = i > 0 ? str[i - 1] : '';
                    const next = i < str.length - 1 ? str[i + 1] : '';
                    // ì–‘ ì˜†ì´ ìˆ«ìë©´ ì²œë‹¨ìœ„ êµ¬ë¶„ìë¡œ ê°„ì£¼í•˜ê³  ê·¸ëŒ€ë¡œ ìœ ì§€
                    if (/\d/.test(prev) && /\d/.test(next)) {
                        current += ch;
                    } else {
                        // ì‹¤ì œ êµ¬ë¶„ì: í˜„ì¬ ë²„í¼ë¥¼ í•­ëª©ìœ¼ë¡œ í™•ì •
                        if (current.trim().length > 0) items.push(current.trim());
                        current = '';
                    }
                } else {
                    current += ch;
                }
            }
            if (current.trim().length > 0) items.push(current.trim());
            return items;
        }
        
        // í…Œì´ë¸” ì •ë ¬
        function sortTable(colIndex) {
            const table = document.getElementById('rawDataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (rows.length === 0) return;
            
            // ì •ë ¬ ë°©í–¥ í† ê¸€
            const currentDir = table.dataset.sortDir === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDir = currentDir;
            
            rows.sort((a, b) => {
                const aVal = a.cells[colIndex]?.textContent.trim() || '';
                const bVal = b.cells[colIndex]?.textContent.trim() || '';
                
                // ìˆ«ì ë¹„êµ
                const aNum = parseFloat(aVal.replace(/,/g, ''));
                const bNum = parseFloat(bVal.replace(/,/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // ë¬¸ìì—´ ë¹„êµ
                return currentDir === 'asc' 
                    ? aVal.localeCompare(bVal, 'ko') 
                    : bVal.localeCompare(aVal, 'ko');
            });
            
            // ìˆœë²ˆ ì¬ì„¤ì • ë° í–‰ ì¬ì‚½ì…
            rows.forEach((row, idx) => {
                row.cells[1].textContent = idx + 1; // ìˆœë²ˆ ì…€ (ì¸ë±ìŠ¤ 1)
                tbody.appendChild(row);
            });
        }
        
        // ë³€í™˜ ë²„íŠ¼ í´ë¦­
        function convertData() {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                alert('ë³€í™˜í•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í™”ì£¼ëª… í™•ì¸
            const shipperSelect = document.getElementById('shipperSelect');
            const shipperInput = document.getElementById('shipperInput');
            let selectedShipper = '';
            
            if (shipperSelect.style.display !== 'none') {
                selectedShipper = shipperSelect.value;
            } else {
                selectedShipper = shipperInput.value.trim();
            }
            
            if (!selectedShipper) {
                alert('í™”ì£¼ëª…ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log(`ğŸ“‹ ì„ íƒëœ í™”ì£¼ëª…: ${selectedShipper}`);
            
            // í˜„ì¬ í…Œì´ë¸” í—¤ë” ê°€ì ¸ì˜¤ê¸°
            const headers = [];
            document.querySelectorAll('#rawDataTableHead th.sortable-header').forEach(th => {
                headers.push(th.textContent.trim());
            });
            
            // í—¤ë” ë§¤í•‘ (rawdata í—¤ë” â†’ containerTable í—¤ë”)
            // ì°¨ìˆœ â†’ SEAL, container â†’ í˜•íƒœ, B/L No â†’ Bl, ì…ê³ ìš”ì²­ì¼ â†’ ë°˜ì…ì¼, ë°œì£¼ í’ˆëª© â†’ í’ˆëª…, ì„ ì ì¼ â†’ íŠ¹ì´ì‚¬í•­
            const headerMapping = {
                'ì°¨ìˆœ': 'SEAL',
                'ì»¨í…Œì´ë„ˆ': 'ê·œê²©',
                'B/L No': 'Bl',
                'ì…ê³ ìš”ì²­ì¼': 'ë°˜ì…ì¼',
                'ë°œì£¼ í’ˆëª©': 'í’ˆëª…',
                'ì„ ì ì¼': 'íŠ¹ì´ì‚¬í•­'
            };
            
            // containerTable í—¤ë” ìˆœì„œ
            const containerTableHeaders = ['ë°˜ì…ì¼', 'í™”ì£¼ëª…', 'ì»¨í…Œì´ë„ˆë²ˆí˜¸', 'SEAL', 'Bl', 'í’ˆëª…', 'ìˆ˜ëŸ‰(EA)', 'ìˆ˜ëŸ‰(PLT)', 'ê·œê²©', 'í˜•íƒœ', 'íŠ¹ì´ì‚¬í•­'];
            
            // ê° rawdata í—¤ë”ê°€ containerTableì˜ ì–´ëŠ ì»¬ëŸ¼ì— ë§¤í•‘ë˜ëŠ”ì§€ ì°¾ê¸°
            const columnMapping = {};
            headers.forEach((header, idx) => {
                const mappedHeader = headerMapping[header] || headerMapping[header.trim()] || null;
                if (mappedHeader) {
                    const targetIdx = containerTableHeaders.indexOf(mappedHeader);
                    if (targetIdx !== -1) {
                        columnMapping[idx] = targetIdx;
                    }
                }   
            });
            
            // ì„ íƒëœ í–‰ ë°ì´í„°ë¥¼ containerTable í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const convertedData = [];
            
            selectedRows.forEach(rowData => {
                const newRow = new Array(containerTableHeaders.length).fill('');
                rowData.forEach((cellData, idx) => {
                    if (columnMapping[idx] !== undefined) {
                        newRow[columnMapping[idx]] = cellData;
                    }
                });
                
                // í™”ì£¼ëª…(ì¸ë±ìŠ¤ 1)ì„ ì„ íƒëœ ê°’ìœ¼ë¡œ ì„¤ì •
                newRow[1] = selectedShipper;
                
                // ë°˜ì…ì¼(ì¸ë±ìŠ¤ 0) ë‚ ì§œ í˜•ì‹ ë³€í™˜: yyyy-mm-ddë¡œ í†µì¼
                if (newRow[0]) {
                    const originalValue = newRow[0];
                    let formattedDate = '';
                    
                    // Date ê°ì²´ì¸ ê²½ìš° (cellDates: true)
                    if (originalValue instanceof Date) {
                        const year = originalValue.getFullYear();
                        const month = String(originalValue.getMonth() + 1).padStart(2, '0');
                        const day = String(originalValue.getDate()).padStart(2, '0');
                        formattedDate = `${year}-${month}-${day}`;
                    }
                    // ìˆ«ìì¸ ê²½ìš° (ì—‘ì…€ ì‹œë¦¬ì–¼ ë‚ ì§œ)
                    else if (typeof originalValue === 'number') {
                        const excelEpoch = new Date(1900, 0, 1);
                        const days = originalValue - 2;
                        const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        formattedDate = `${year}-${month}-${day}`;
                    }
                    // ë¬¸ìì—´ì¸ ê²½ìš°
                    else {
                        const dateStr = originalValue.toString().trim();
                        
                        // YYYY-MM-DD í˜•ì‹ì´ë©´ ìœ ì§€
                        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            formattedDate = dateStr;
                        }
                        // YYYY/MM/DD í˜•ì‹
                        else if (/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) {
                            formattedDate = dateStr.replace(/\//g, '-');
                        }
                        // MM/DD/YYYY í˜•ì‹
                        else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                            const parts = dateStr.split('/');
                            const month = parts[0].padStart(2, '0');
                            const day = parts[1].padStart(2, '0');
                            const year = parts[2];
                            formattedDate = `${year}-${month}-${day}`;
                        }
                        // YYYY.MM.DD í˜•ì‹
                        else if (/^\d{4}\.\d{2}\.\d{2}$/.test(dateStr)) {
                            formattedDate = dateStr.replace(/\./g, '-');
                        }
                        // ìˆ«ì ë¬¸ìì—´ (ì—‘ì…€ ì‹œë¦¬ì–¼)
                        else if (!isNaN(parseFloat(dateStr)) && isFinite(dateStr)) {
                            const excelEpoch = new Date(1900, 0, 1);
                            const days = parseFloat(dateStr) - 2;
                            const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            formattedDate = `${year}-${month}-${day}`;
                        }
                        // dd(ìš”ì¼) í˜•ì‹ ì²˜ë¦¬ - í˜„ì¬ ë…„/ì›” ì‚¬ìš©
                        else if (/^\d{1,2}\([ê°€-í£]+\)$/.test(dateStr)) {
                            const day = dateStr.match(/^\d{1,2}/)[0].padStart(2, '0');
                            const now = new Date();
                            const year = now.getFullYear();
                            const month = String(now.getMonth() + 1).padStart(2, '0');
                            formattedDate = `${year}-${month}-${day}`;
                        }
                        else {
                            formattedDate = dateStr;
                        }
                    }
                    
                    newRow[0] = formattedDate;
                }
                
                // ê·œê²©(ì¸ë±ìŠ¤ 8) ìë™ ì„¤ì •: "ì»¨í…Œì´ë„ˆ" ì—´ ë‚´ìš© ê¸°ë°˜
                // rawdataì˜ "ì»¨í…Œì´ë„ˆ" ì—´ì´ ê·œê²© í•„ë“œë¡œ ë§¤í•‘ë˜ë¯€ë¡œ í•´ë‹¹ ê°’ì„ ë¶„ì„
                if (newRow[8]) {
                    const containerValue = newRow[8].toString().trim();
                    
                    // 2ë¥¼ í¬í•¨í•˜ë©´ 20FT
                    if (containerValue.includes('2')) {
                        newRow[8] = '20FT';
                    }
                    // 4ë¥¼ í¬í•¨í•˜ë©´ 40FT
                    else if (containerValue.includes('4')) {
                        newRow[8] = '40FT';
                    }
                    // ê·¸ ì™¸ LCL
                    else {
                        newRow[8] = 'LCL';
                    }
                }
                
                // ë°œì£¼ í’ˆëª©(ì¸ë±ìŠ¤ 5) í•„í„°ë§: "," í¬í•¨ì‹œ splití•˜ì—¬ ìƒˆë¡œìš´ row ìƒì„±
                const itemName = newRow[5] ? newRow[5].toString().trim() : '';
                
                // "," í¬í•¨ ì—¬ë¶€ í™•ì¸ (ìˆ«ì ì‚¬ì´ì˜ "," ëŠ” ì²œë‹¨ìœ„ë¡œ ì¸ì •í•˜ì—¬ ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ)
                const itemList = splitItemsPreservingThousands(itemName)
                    .map(item => item.trim())
                    .filter(item => item.length > 0)
                    .sort((a, b) => a.localeCompare(b, 'ko-KR'));
                if (itemList.length > 1) {
                    
                    // ì •ë ¬ëœ ê° í•­ëª©ë³„ë¡œ ìƒˆë¡œìš´ row ìƒì„±
                    itemList.forEach(item => {
                        const rowWithItem = [...newRow];
                        
                        // "-ìˆ«ìp" íŒ¨í„´ ì²´í¬ (Pallet) - ë‹¤ì–‘í•œ í•˜ì´í”ˆ/ê³µë°± í—ˆìš©
                        const palletMatch = item.match(/(?:-|â€“|â€”)\s*(\d[\d,]*)\s*p$/i);
                        if (palletMatch) {
                            // "-" ì´ì „ê¹Œì§€ë§Œ í’ˆëª…ì— ì €ì¥
                            rowWithItem[5] = item.substring(0, item.indexOf('-')).trim();
                            rowWithItem[9] = 'Pallet'; // í˜•íƒœ(ì¸ë±ìŠ¤ 9)
                            // ì²œë‹¨ìœ„ ì½¤ë§ˆ ì œê±° í›„ ìˆ«ì íŒŒì‹±
                            rowWithItem[7] = parseInt(String(palletMatch[1]).replace(/,/g, '')) || 0; // ìˆ˜ëŸ‰(PLT)(ì¸ë±ìŠ¤ 7)
                            convertedData.push(rowWithItem);
                            return;
                        }
                        
                        // "-ìˆ«ìb" íŒ¨í„´ ì²´í¬ (Bulk) - ë‹¤ì–‘í•œ í•˜ì´í”ˆ/ê³µë°± í—ˆìš©
                        const bulkMatch = item.match(/(?:-|â€“|â€”)\s*(\d[\d,]*)\s*b$/i);
                        if (bulkMatch) {
                            // "-" ì´ì „ê¹Œì§€ë§Œ í’ˆëª…ì— ì €ì¥
                            rowWithItem[5] = item.substring(0, item.indexOf('-')).trim();
                            rowWithItem[9] = 'Bulk'; // í˜•íƒœ(ì¸ë±ìŠ¤ 9)
                            rowWithItem[6] = parseInt(String(bulkMatch[1]).replace(/,/g, '')) || 0; // ìˆ˜ëŸ‰(EA)(ì¸ë±ìŠ¤ 6)
                            convertedData.push(rowWithItem);
                            return;
                        }
                        
                        // ë§ˆì§€ë§‰ ë¬¸ì í™•ì¸ (íŒ¨í„´ ì—†ì´ pë‚˜ bë¡œë§Œ ëë‚˜ëŠ” ê²½ìš°)
                        const lastChar = item.charAt(item.length - 1).toLowerCase();
                        if (lastChar === 'p') {
                            rowWithItem[5] = item;
                            rowWithItem[9] = 'Pallet'; // pë¡œ ëë‚˜ë©´ í˜•íƒœë§Œ ì„¤ì •
                        } else if (lastChar === 'b') {
                            rowWithItem[5] = item;
                            rowWithItem[9] = 'Bulk'; // bë¡œ ëë‚˜ë©´ í˜•íƒœë§Œ ì„¤ì •
                        } else {
                            // pë‚˜ bë¡œ ëë‚˜ì§€ ì•Šìœ¼ë©´ ê·¸ëŒ€ë¡œ í’ˆëª…ì— ì €ì¥
                            rowWithItem[5] = item;
                        }
                        
                        convertedData.push(rowWithItem);
                    });
                } else {
                    // "," ë¯¸í¬í•¨ì‹œ - p/b ì²˜ë¦¬ í•„ìš”
                    
                    // "-ìˆ«ìp" íŒ¨í„´ ì²´í¬ (Pallet) - ë‹¤ì–‘í•œ í•˜ì´í”ˆ/ê³µë°± í—ˆìš©
                    const palletMatch = itemName.match(/(?:-|â€“|â€”)\s*(\d[\d,]*)\s*p$/i);
                    if (palletMatch) {
                        // "-" ì´ì „ê¹Œì§€ë§Œ í’ˆëª…ì— ì €ì¥
                        newRow[5] = itemName.substring(0, itemName.indexOf('-')).trim();
                        newRow[9] = 'Pallet'; // í˜•íƒœ(ì¸ë±ìŠ¤ 9)
                        newRow[7] = parseInt(String(palletMatch[1]).replace(/,/g, '')) || 0; // ìˆ˜ëŸ‰(PLT)(ì¸ë±ìŠ¤ 7)
                        convertedData.push(newRow);
                        return;
                    }
                    
                    // "-ìˆ«ìb" íŒ¨í„´ ì²´í¬ (Bulk) - ë‹¤ì–‘í•œ í•˜ì´í”ˆ/ê³µë°± í—ˆìš©
                    const bulkMatch = itemName.match(/(?:-|â€“|â€”)\s*(\d[\d,]*)\s*b$/i);
                    if (bulkMatch) {
                        // "-" ì´ì „ê¹Œì§€ë§Œ í’ˆëª…ì— ì €ì¥
                        newRow[5] = itemName.substring(0, itemName.indexOf('-')).trim();
                        newRow[9] = 'Bulk'; // í˜•íƒœ(ì¸ë±ìŠ¤ 9)
                        newRow[6] = parseInt(String(bulkMatch[1]).replace(/,/g, '')) || 0; // ìˆ˜ëŸ‰(EA)(ì¸ë±ìŠ¤ 6)
                        convertedData.push(newRow);
                        return;
                    }
                    
                    // ë§ˆì§€ë§‰ ë¬¸ì í™•ì¸ (íŒ¨í„´ ì—†ì´ pë‚˜ bë¡œë§Œ ëë‚˜ëŠ” ê²½ìš°)
                    const lastChar = itemName.charAt(itemName.length - 1).toLowerCase();
                    if (lastChar === 'p') {
                        newRow[5] = itemName;
                        newRow[9] = 'Pallet'; // pë¡œ ëë‚˜ë©´ í˜•íƒœë§Œ ì„¤ì •
                    } else if (lastChar === 'b') {
                        newRow[5] = itemName;
                        newRow[9] = 'Bulk'; // bë¡œ ëë‚˜ë©´ í˜•íƒœë§Œ ì„¤ì •
                    } else {
                        // pë‚˜ bë¡œ ëë‚˜ì§€ ì•Šìœ¼ë©´ ê·¸ëŒ€ë¡œ ì €ì¥
                        newRow[5] = itemName;
                    }
                    
                    convertedData.push(newRow);
                }
            });
            
            // localStorageì— ë³€í™˜ëœ ë°ì´í„° ì €ì¥
            localStorage.setItem('convertedRawData', JSON.stringify({
                headers: containerTableHeaders,
                data: convertedData
            }));
            
            alert(`${selectedRows.length}ê°œ í–‰ì´ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
            
            // ì›ë˜ ì°½(opener)ì— ë°ì´í„° ì „ë‹¬ ì‹œë„
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.loadConvertedRawData();
                } catch (e) {
                    // ì—ëŸ¬ ë¬´ì‹œ
                }
            }
        }
        
        // ë“±ë¡ ë²„íŠ¼ í´ë¦­
        function registerData() {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                alert('ë“±ë¡í•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            alert(`${selectedRows.length}ê°œ í–‰ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.`);
        }
    </script>
</body>
</html>
